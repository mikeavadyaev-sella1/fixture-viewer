<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fixture Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --accent:#22c55e;
      --accent2:#38bdf8;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2937;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
    }

    body{
      background:radial-gradient(circle at top, #1e293b, #020617);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--text);
      padding:4px;              /* было 10px — сделали меньше */
      overflow:auto;            /* вернули прокрутку */
      display:block;            /* убрал flex, чтобы было естественное поведение */
    }

    .wrap{
      width:100%;
      max-width:600px;          /* страница стала шире */
      min-height:100vh;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
    }

    /* === MENU BAR === */
    .menu-bar{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:6px 4px;          /* было 6px 8px — уменьшили по бокам */
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      box-shadow:0 16px 40px rgba(0,0,0,.4);
      flex:0 0 auto;
    }

    .menu-top{
      display:flex;
      gap:6px;
      align-items:center;
    }

    .menu-icon-btn{
      width:38px;
      height:38px;
      padding:4px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }

    .menu-icon-btn img{
      max-width:100%;
      max-height:100%;
      display:block;
    }

    .menu-icon-btn:active{
      transform:translateY(1px);
    }

    .menu-select{
      flex:1 1 auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:13px;
      outline:none;
      min-width:0;
    }

    .menu-select option[value="manual"]{
      color:var(--accent2);
    }

    /* === VIEWER === */
    .viewer-shell{
      border-radius:16px;
      border:1px solid var(--border);
      background:#111827;
      padding:8px 6px 10px;   /* чуть меньше по бокам */
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1 1 auto;
      min-height:0;
    }

    .viewer-frame{
      flex:1 1 auto;
      width:100%;
      border:none;
      border-radius:10px;
      background:#020617;
      display:block;
      min-height:0;
    }

    .viewer-info{
      font-size:11px;
      color:var(--muted);
    }

    /* === SCAN MODAL === */
    .scan-backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.7);
      z-index:1000;
    }

    .scan-card{
      width:100%;
      max-width:480px;
      background:#111827;
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(0,0,0,.8);
      padding:14px 14px 12px;
    }

    .scan-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .scan-title{
      font-size:16px;
      font-weight:600;
    }

    .scan-close{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:18px;
      line-height:1;
      padding:2px 4px;
    }

    .video-wrap{
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      padding:6px 8px 8px;
      margin-bottom:8px;
    }

    #video{
      width:100%;
      max-height:240px;
      border-radius:8px;
      background:#000;
      display:block;
    }

    .box{
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      padding:6px 8px;
      font-size:11px;
      min-height:42px;
      max-height:120px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-all;
    }

    .box.placeholder{
      color:var(--muted);
      font-style:italic;
    }

    .scan-footer{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .scan-btn{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--accent);
      background:#020617;
      color:var(--accent);
      font-size:13px;
      cursor:pointer;
    }

    .scan-btn-secondary{
      border-color:var(--border);
      color:var(--muted);
    }

    .scan-btn:active{
      transform:translateY(1px);
    }

    /* === MANUAL POPUP === */
    .manual-popup{
      position:absolute;
      top:64px;
      right:10px;
      min-width:220px;
      background:#020617;
      border:1px solid var(--border);
      border-radius:10px;
      box-shadow:0 18px 40px rgba(0,0,0,.7);
      display:none;
      z-index:1200;
    }

    .manual-popup-card{
      padding:8px;
    }

    .manual-popup-title{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .manual-popup-list{
      max-height:220px;
      overflow:auto;
      margin:-2px;
      padding:2px;
    }

    .manual-item{
      padding:6px 8px;
      font-size:13px;
      border-radius:8px;
      cursor:pointer;
      color:var(--text);
    }

    .manual-item:hover{
      background:#111827;
    }

    /* === SHARE MODAL (QR ссылки на приложение) === */
    #shareModal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.75);
      z-index:1500;
    }

    .share-card{
      background:#111827;
      border-radius:14px;
      border:1px solid var(--border);
      padding:14px 16px 12px;
      text-align:center;
      max-width:260px;
      width:100%;
      box-shadow:0 20px 50px rgba(0,0,0,0.8);
    }

    .share-title{
      font-size:14px;
      font-weight:500;
      margin-bottom:8px;
    }

    .share-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }

    #shareQrCanvas{
      display:block;
      margin:0 auto 10px;
      border-radius:10px;
      background:#ffffff;
    }

    #closeShareBtn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:13px;
      cursor:pointer;
    }

    #closeShareBtn:active{
      transform:translateY(1px);
    }

    /* версия внизу */
    #appVersion{
      position:fixed;
      bottom:4px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      color:#64748b;
      opacity:0.85;
      user-select:none;
      pointer-events:none;
      text-align:center;
      z-index:1600;
    }
  </style>

  <!-- jsQR для чтения QR JSON -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- QRious для генерации QR ссылки на приложение -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#020617">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
  <div class="wrap">
    <!-- MENU BAR -->
    <div class="menu-bar">
      <div class="menu-top">
        <!-- Scan QR (JSON для fixtures) -->
        <button id="btnScan" class="menu-icon-btn" type="button" aria-label="Scan QR">
          <img src="qr.png" alt="Scan">
        </button>

        <select id="viewerSelect" class="menu-select">
          <!-- заполняется скриптом -->
        </select>

        <!-- Share app link via QR -->
        <button id="btnShare" class="menu-icon-btn" type="button" aria-label="Share app">
          <img src="share.png" alt="Share">
        </button>

        <!-- Exit PWA -->
        <button id="btnExit" class="menu-icon-btn" type="button" aria-label="Exit app">
          <img src="exi.png" alt="Exit">
        </button>
      </div>
    </div>

    <!-- VIEWER -->
    <div class="viewer-shell">
      <iframe id="viewerFrame" class="viewer-frame" src="" title="Fixture viewer"></iframe>
      <div id="viewerInfo" class="viewer-info">
        No fixture loaded. Use manual selection to pick fixtures/&lt;name&gt;.html, then QR entries to send probes into probeInput.
      </div>
    </div>

    <!-- MANUAL SELECTION POPUP -->
    <div id="manualPopup" class="manual-popup">
      <div class="manual-popup-card">
        <div class="manual-popup-title">Select fixture from fixtures/</div>
        <div id="manualList" class="manual-popup-list"></div>
      </div>
    </div>
  </div>

  <!-- SCAN MODAL (камера для JSON QR) -->
  <div id="scanModal" class="scan-backdrop">
    <div class="scan-card">
      <div class="scan-header">
        <div>
          <div class="scan-title">Scan QR</div>
          <div style="font-size:11px;color:var(--muted);">Point the camera at QR code with JSON for fixtures.</div>
        </div>
        <button id="scanClose" class="scan-close" type="button">×</button>
      </div>

      <div class="video-wrap">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Camera</div>
        <video id="video" playsinline></video>
      </div>

      <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Raw QR data</div>
      <div id="rawBox" class="box placeholder">
        Waiting for camera…
      </div>

      <div class="scan-footer">
        <button id="scanStop" class="scan-btn scan-btn-secondary" type="button">Stop</button>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL (QR со ссылкой на приложение) -->
  <div id="shareModal">
    <div class="share-card">
      <div class="share-title">Share Fixture Viewer</div>
      <div class="share-sub">Scan this QR to open and install the app.</div>
      <canvas id="shareQrCanvas" width="240" height="240"></canvas>
      <button id="closeShareBtn" type="button">Close</button>
    </div>
  </div>

  <!-- версия приложения -->
  <div id="appVersion"></div>

  <script>
    // версию надо менять вместе с APP_VERSION в sw.js
    const APP_VERSION_STRING = 'fv-2025-11-18-02';

    const rawBox       = document.getElementById('rawBox');
    const scanModal    = document.getElementById('scanModal');
    const scanCloseBtn = document.getElementById('scanClose');
    const scanStopBtn  = document.getElementById('scanStop');
    const videoEl      = document.getElementById('video');

    const btnScan      = document.getElementById('btnScan');
    const btnShare     = document.getElementById('btnShare');
    const btnExit      = document.getElementById('btnExit');

    const viewerSelect = document.getElementById('viewerSelect');
    const viewerFrame  = document.getElementById('viewerFrame');
    const viewerInfo   = document.getElementById('viewerInfo');

    const manualPopup  = document.getElementById('manualPopup');
    const manualList   = document.getElementById('manualList');

    const shareModal   = document.getElementById('shareModal');
    const shareQrCanvas= document.getElementById('shareQrCanvas');
    const closeShareBtn= document.getElementById('closeShareBtn');

    const appVersionEl = document.getElementById('appVersion');
    if (appVersionEl) appVersionEl.textContent = 'v ' + APP_VERSION_STRING;

    let stream   = null;
    let scanRaf  = null;
    let scanning = false;

    const MANUAL_VALUE = 'manual';

    // map: "AP1264-030-3" -> { id, key, label, probes }
    const viewerMap = {};
    let fixturesCache = null;
    let pendingProbes = null; // probes, которые надо вписать после загрузки viewer

    function setRaw(text){
      rawBox.textContent = text;
      rawBox.classList.remove('placeholder');
    }

    function setViewerMessage(msg){
      if (viewerInfo) viewerInfo.textContent = msg;
    }

    function collectFixtureOptions(){
      return Array.from(viewerSelect.options)
        .filter(o => o.value && o.value.startsWith('fixtures/'))
        .map(o => {
          const c = document.createElement('option');
          c.value = o.value;
          c.textContent = o.textContent;
          return c;
        });
    }

    function resetViewerSelectBase(fixturesOptions){
      viewerSelect.innerHTML = '';

      const chooseOpt = document.createElement('option');
      chooseOpt.value = '';
      chooseOpt.textContent = 'choose...';
      viewerSelect.appendChild(chooseOpt);
      viewerSelect.value = '';

      if (Array.isArray(fixturesOptions)) {
        fixturesOptions.forEach(opt => viewerSelect.appendChild(opt));
      }

      const manualOpt = document.createElement('option');
      manualOpt.value = MANUAL_VALUE;
      manualOpt.textContent = 'manual selection';
      viewerSelect.appendChild(manualOpt);
    }

    function clearViewerFromQR(){
      Object.keys(viewerMap).forEach(k => delete viewerMap[k]);
      const fixturesOptions = collectFixtureOptions();
      resetViewerSelectBase(fixturesOptions);
      pendingProbes = null;
      setViewerMessage('No fixture loaded. Use QR or manual selection.');
    }

    function buildViewerListFromJson(rawText){
      let obj;
      try {
        obj = JSON.parse(rawText);
      } catch (e) {
        setViewerMessage('QR data is not valid JSON, viewer list not built.');
        clearViewerFromQR();
        return;
      }

      Object.keys(viewerMap).forEach(k => delete viewerMap[k]);
      const fixturesOptions = collectFixtureOptions();
      const keys = Object.keys(obj);
      const qrOptions = [];

      keys.forEach(key => {
        const arr = obj[key];
        if (!Array.isArray(arr)) return;
        arr.forEach(item => {
          const label  = (item && (item.label ?? item.l)) || '';
          const probes = (item && (item.probes ?? item.p)) || '';
          if (!label || !probes) return;
          const id = `${key}-${label}`;
          viewerMap[id] = { id, key, label, probes };
          qrOptions.push(id);
        });
      });

      viewerSelect.innerHTML = '';

      const chooseOpt = document.createElement('option');
      chooseOpt.value = '';
      chooseOpt.textContent = 'choose...';
      viewerSelect.appendChild(chooseOpt);
      viewerSelect.value = '';

      qrOptions.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        viewerSelect.appendChild(opt);
      });

      fixturesOptions.forEach(opt => viewerSelect.appendChild(opt));

      const manualOpt = document.createElement('option');
      manualOpt.value = MANUAL_VALUE;
      manualOpt.textContent = 'manual selection';
      viewerSelect.appendChild(manualOpt);

      pendingProbes = null;
      setViewerMessage('Select QR entry to load fixtures/<AP>.html and send probes into probeInput, or use manual selection for fixtures.');
    }

    function sendProbesToFixture(probes){
      if (!viewerFrame || !viewerFrame.contentWindow) return;
      try {
        const doc = viewerFrame.contentWindow.document;
        if (!doc) return;
        const input = doc.getElementById('probeInput');
        if (!input) return;

        input.value = probes;

        try {
          const evInit = { bubbles: true, cancelable: true };
          input.dispatchEvent(new Event("input", evInit));
          input.dispatchEvent(new Event("change", evInit));
        } catch(e2){
          const evtInput  = doc.createEvent("HTMLEvents");
          evtInput.initEvent("input", true, true);
          input.dispatchEvent(evtInput);

          const evtChange = doc.createEvent("HTMLEvents");
          evtChange.initEvent("change", true, true);
          input.dispatchEvent(evtChange);
        }

      } catch (e) {
        console.warn('Cannot access probeInput inside iframe:', e);
      }
    }

    function onViewerSelectChange(){
      const v = viewerSelect.value;

      if (!v) {
        pendingProbes = null;
        return;
      }

      if (v === MANUAL_VALUE) {
        openManualPopup();
        pendingProbes = null;
        return;
      }

      if (viewerMap[v]) {
        const item = viewerMap[v];
        const viewerPath = 'fixtures/' + item.key + '.html';
        pendingProbes = item.probes;

        if (viewerFrame.src !== viewerPath) {
          viewerFrame.src = viewerPath;
          setViewerMessage('Loaded viewer for ' + item.key + ', waiting for load to send probes.');
        } else {
          sendProbesToFixture(item.probes);
          setViewerMessage('Sent probes to existing viewer: ' + item.key);
          pendingProbes = null;
        }
        return;
      }

      pendingProbes = null;
      viewerFrame.src = v;
      setViewerMessage('Loaded fixture: ' + v);
    }

    /* === MANUAL POPUP === */
    function openManualPopup(){
      if (!manualPopup) return;

      if (fixturesCache) {
        fillManualPopup(fixturesCache);
        manualPopup.style.display = 'block';
        return;
      }

      fetch('fixtures/list.json', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(list => {
          if (!Array.isArray(list)) throw new Error('list.json must be an array');
          fixturesCache = list;
          fillManualPopup(list);
          manualPopup.style.display = 'block';
        })
        .catch(err => {
          console.error(err);
          setViewerMessage('Cannot load fixtures/list.json');
        });
    }

    function fillManualPopup(list){
      manualList.innerHTML = '';
      if (!list.length) {
        const div = document.createElement('div');
        div.className = 'manual-item';
        div.textContent = '(no fixtures in list.json)';
        manualList.appendChild(div);
        return;
      }
      list.forEach(name => {
        const div = document.createElement('div');
        div.className = 'manual-item';
        div.textContent = name;
        div.addEventListener('click', () => {
          onFixturePicked(name);
        });
        manualList.appendChild(div);
      });
    }

    function closeManualPopup(){
      if (manualPopup) manualPopup.style.display = 'none';
    }

    function onFixturePicked(fileName){
      closeManualPopup();
      const value = 'fixtures/' + fileName;

      Array.from(viewerSelect.options).forEach(opt => {
        if (opt.value === value) viewerSelect.removeChild(opt);
      });

      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = fileName;

      if (viewerSelect.children.length > 0) {
        viewerSelect.insertBefore(opt, viewerSelect.children[1] || null);
      } else {
        viewerSelect.appendChild(opt);
      }

      let manualOpt = Array.from(viewerSelect.options).find(o => o.value === MANUAL_VALUE);
      if (!manualOpt) {
        manualOpt = document.createElement('option');
        manualOpt.value = MANUAL_VALUE;
        manualOpt.textContent = 'manual selection';
        viewerSelect.appendChild(manualOpt);
      } else {
        viewerSelect.removeChild(manualOpt);
        viewerSelect.appendChild(manualOpt);
      }

      viewerSelect.value = value;
      onViewerSelectChange();
    }

    document.addEventListener('click', (e) => {
      if (!manualPopup) return;
      if (manualPopup.style.display !== 'block') return;
      const target = e.target;
      if (manualPopup.contains(target)) return;
      if (target === viewerSelect) return;
      closeManualPopup();
    });

    /* === SCAN (JSON QR) === */
    function stopScan(){
      scanning = false;
      if (scanRaf) {
        cancelAnimationFrame(scanRaf);
        scanRaf = null;
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    function closeScanModal(){
      stopScan();
      if (scanModal) scanModal.style.display = 'none';
    }

    function openScanModal(){
      if (!scanModal) return;
      scanModal.style.display = 'flex';
      startScan();
    }

    function tickScan(){
      if (!scanning) return;
      if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
        const w = videoEl.videoWidth;
        const h = videoEl.videoHeight;
        if (w && h) {
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(videoEl, 0, 0, w, h);
          const imgData = ctx.getImageData(0, 0, w, h);
          const code = jsQR(imgData.data, imgData.width, imgData.height, {
            inversionAttempts: 'dontInvert'
          });
          if (code && code.data) {
            const text = code.data;
            setRaw(text);
            buildViewerListFromJson(text);
            closeScanModal();
            return;
          }
        }
      }
      scanRaf = requestAnimationFrame(tickScan);
    }

    async function startScan(){
      if (scanning) return;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Camera access is not supported in this browser.');
        return;
      }

      try {
        rawBox.classList.add('placeholder');
        rawBox.textContent = 'Scanning… Point the camera at QR code.';

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });

        videoEl.srcObject = stream;
        videoEl.setAttribute('playsinline', 'true');

        await videoEl.play();

        scanning = true;
        tickScan();
      } catch (e) {
        console.error(e);
        stopScan();
        rawBox.classList.add('placeholder');
        rawBox.textContent = 'Cannot start camera. Check permissions.';
      }
    }

    /* === SHARE APP QR === */
    function openShareModal(){
      const url = "https://mikeavadyaev-sella1.github.io/fixture-viewer/";
      new QRious({
        element: shareQrCanvas,
        value: url,
        size: 240,
        background: "#ffffff",
        foreground: "#000000"
      });
      shareModal.style.display = 'flex';
    }

    function closeShareModal(){
      shareModal.style.display = 'none';
    }

    /* === EXIT PWA ===
       Из-за ограничений браузера полностью "убить" окно нельзя,
       поэтому поведение = назад.
    */
    function exitApp(){
      // попытка закрыть окно (чаще всего игнорируется)
      window.close();
      // fallback: шаг назад
      setTimeout(() => {
        history.back();
      }, 150);
    }

    /* === EVENTS === */
    btnScan.addEventListener('click', openScanModal);
    scanCloseBtn.addEventListener('click', closeScanModal);
    scanStopBtn.addEventListener('click', closeScanModal);

    viewerSelect.addEventListener('change', onViewerSelectChange);

    window.addEventListener('beforeunload', () => {
      stopScan();
    });

    btnShare.addEventListener('click', openShareModal);
    closeShareBtn.addEventListener('click', closeShareModal);
    shareModal.addEventListener('click', (e) => {
      if (e.target === shareModal) closeShareModal();
    });

    btnExit.addEventListener('click', exitApp);

    // начальное состояние select
    resetViewerSelectBase([]);
    setViewerMessage('No fixture loaded. Use manual selection to pick fixtures/<name>.html, then QR entries to send probes into probeInput.');

    // probes после загрузки viewer
    viewerFrame.addEventListener('load', () => {
      if (pendingProbes != null) {
        sendProbesToFixture(pendingProbes);
        setViewerMessage('Sent probes to probeInput after loading viewer.');
        pendingProbes = null;
      }
    });
  </script>

  <!-- регистрация service worker для PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('./sw.js')
          .catch(function (err) {
            console.warn('SW registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
